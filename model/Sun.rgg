/*wy131125
module A(int t, int day);
module B(int t, int day, float pow) extends LightNode()//Sphere(0.1)
{ 
	{setLight(new PointLight().(setPower(pow)));}
} ==> TextLabel(t).(setColor(new Color3f(0,0,0)));

// module C(int t, int day, float pow) extends LightNode()
//{
//	{setLight(new SunSkyLight().(setPower(pow)));}
//}

public @Editable @Range(min=1,max=365) int dayofyear = 90;
public @Editable @Range(min=0,max=80) int latitude = 1;
int time = 24; //time of the day [hours]
int day = dayofyear;
float distfact = 2.5f; //distance factor to position the sun

//computation of diffuse fraction of incident radiation as a function of atmospheric 
//transmissivity
const DatasetRef radiation = new DatasetRef("Fraction diffuse radiation");*/

float FractionDiffuse (float ta)
{
	float df;
	//float a = (1-0.2)/(0.7-0.3);
	float a = -1.57;
	if (ta<=0.3) {return df = 1;}
	else if (ta>0.7) {return df = 0.2;}
	else {return df = a*ta + 1.3;}
}

/*wy131125
const float[] GlobalRadiation = {6.555921418, 6.609028324, 6.666677387, 6.728872543, 
	6.795617401, 6.866915157, 6.942768492, 7.023179479, 7.108149479, 7.197679044, 
7.291767815, 7.390414427, 7.493616406, 7.601370075, 7.713670465, 7.830511216, 
7.9518845, 8.07778093, 8.208189485, 8.343097437, 8.482490279, 8.626351662, 
8.774663337, 8.927405099, 9.084554743, 9.246088019, 9.411978596, 9.582198031, 
9.756715746, 9.935499003, 10.1185129, 10.30572034, 10.49708205, 10.69255659, 
10.89210032, 11.09566745, 11.30321003, 11.51467797, 11.7300191, 11.94917915, 
12.17210181, 12.39872873, 12.62899963, 12.86285224, 13.10022243, 13.34104422, 
13.58524981, 13.83276965, 14.08353252, 14.33746551, 14.59449415, 14.85454241, 
15.1175328, 15.38338639, 15.65202289, 15.92336071, 16.19731701, 16.47380775, 
16.75274778, 17.03405086, 17.31762977, 17.6033963, 17.89126137, 18.18113506, 
18.47292668, 18.7665448, 19.06189733, 19.35889157, 19.65743427, 19.95743166, 
20.25878953, 20.56141326, 20.86520787, 21.17007809, 21.47592837, 21.78266297, 
22.09018597, 22.39840132, 22.70721288, 23.01652447, 23.32623992, 23.63626305, 
23.94649778, 24.25684811, 24.56721816, 24.87751223, 25.1876348, 25.49749056, 
25.80698444, 26.11602165, 26.42450768, 26.73234831, 27.03944967, 27.34571824, 
27.65106083, 27.95538466, 28.25859733, 28.56060682, 28.86132156, 29.16065036, 
29.4585025, 29.75478767, 30.04941601, 30.34229811, 30.63334499, 30.92246814, 
31.20957952, 31.49459149, 31.77741693, 32.05796913, 32.33616185, 32.61190929, 
32.88512611, 33.15572743, 33.42362879, 33.68874619, 33.95099609, 34.21029535, 
34.46656133, 34.71971179, 34.96966495, 35.21633948, 35.45965452, 35.69952963, 
35.93588487, 36.16864077, 36.39771833, 36.62303907, 36.84452501, 37.06209872, 
37.27568332, 37.48520252, 37.69058061, 37.89174256, 38.088614, 38.28112125, 
38.46919141, 38.65275238, 38.8317329, 39.00606262, 39.17567213, 39.34049306, 
39.50045813, 39.65550119, 39.80555733, 39.95056295, 40.09045582, 40.22517516, 
40.35466178, 40.47885807, 40.59770818, 40.71115808, 40.81915563, 40.9216507, 
41.01859526, 41.10994348, 41.19565179, 41.27567902, 41.34998647, 41.41853798, 
41.48130005, 41.53824188, 41.58933549, 41.63455577, 41.67388055, 41.70729067, 
41.73477001, 41.75630558, 41.77188751, 41.78150914, 41.78516699, 41.78286082, 
41.77459363, 41.76037163, 41.74020426, 41.71410419, 41.68208726, 41.64417244, 
41.60038185, 41.55074062, 41.49527693, 41.43402187, 41.36700941, 41.29427631, 
41.21586205, 41.13180872, 41.04216095, 40.94696582, 40.84627275, 40.74013339, 
40.62860155, 40.51173305, 40.38958569, 40.26221904, 40.12969445, 39.99207487, 
39.84942478, 39.70181007, 39.54929798, 39.39195698, 39.22985667, 39.06306772, 
38.89166177, 38.71571136, 38.53528982, 38.35047127, 38.16133046, 37.96794279, 
37.77038419, 37.56873112, 37.36306046, 37.15344952, 36.93997594, 36.72271773, 
36.50175316, 36.27716075, 36.04901929, 35.81740774, 35.58240529, 35.34409129, 
35.10254523, 34.85784677, 34.61007572, 34.35931201, 34.10563571, 33.84912701, 
33.58986624, 33.32793385, 33.06341045, 32.79637676, 32.52691365, 32.25510216, 
31.98102346, 31.7047589, 31.42639, 31.14599844, 30.86366612, 30.57947512, 
30.29350771, 30.00584639, 29.71657388, 29.42577311, 29.13352725, 28.83991969, 
28.5450341, 28.24895436, 27.9517646, 27.65354922, 27.35439285, 27.05438038, 
26.75359695, 26.45212793, 26.15005895, 25.84747587, 25.54446479, 25.24111199, 
24.93750402, 24.63372758, 24.32986958, 24.02601712, 23.72225742, 23.41867786, 
23.11536596, 22.8124093, 22.50989557, 22.20791251, 21.90654789, 21.60588948, 
21.30602502, 21.00704222, 20.70902868, 20.4120719, 20.1162592, 19.82167774, 
19.52841445, 19.23655598, 18.94618868, 18.65739856, 18.37027125, 18.08489192, 
17.80134527, 17.51971549, 17.24008619, 16.96254034, 16.68716025, 16.41402752, 
16.14322296, 15.87482656, 15.60891743, 15.34557374, 15.0848727, 14.82689045, 
14.57170206, 14.31938144, 14.0700013, 13.8236331, 13.58034699, 13.34021177, 
13.10329481, 12.86966203, 12.63937784, 12.41250509, 12.18910501, 11.9692372, 
11.75295955, 11.54032823, 11.33139764, 11.12622036, 10.92484715, 10.72732687, 
10.53370654, 10.34403121, 10.15834404, 9.976686225, 9.799097, 9.625613647, 
9.456271487, 9.291103881, 9.130142244, 8.973416057, 8.820952891, 8.672778428, 
8.528916493, 8.389389092, 8.254216452, 8.123417069, 7.997007757, 7.875003713, 
7.757418571, 7.644264477, 7.535552153, 7.431290981, 7.33148908, 7.236153386, 
7.145289746, 7.058903001, 6.976997079, 6.89957509, 6.826639419, 6.758191815, 
6.694233493, 6.634765219, 6.579787404, 6.529300192, 6.483303544, 6.441797321, 
6.404781357, 6.372255534, 6.344219846, 6.320674456, 6.301619752, 6.287056389, 
6.276985326, 6.271407856, 6.270325625, 6.273740643, 6.281655288, 6.294072299, 
6.31099476, 6.332426078, 6.358369949, 6.388830317, 6.423811326, 6.463317265, 
6.507352503};
// Global daily incident radiation (MJ m-2 d-1) for 365 days of the year for the
// latitude 52 degrees North (Wageningen), based on formula by Goudriaan & van Laar 
// (1994) Take these daily values as a maximum for computation of average transmissivity

/* const float[] ta = {0.006281871, 0.225178916, 0.81101549, 0.113560299, 0.744788052, 0.60032953, 
0.343224416, 0.109332099, 0.803899273, 0.551901707, 0.22297243, 0.049948771, 0.555897124, 
0.342040852, 0.650504978, 0.883008294, 0.613657407, 0.806941463, 0.734206689, 0.27542896, 
0.881599701, 0.59086402, 0.168206525, 0.706533114, 0.90226966, 0.791240893, 0.231480764, 
0.568098775, 0.392615619, 0.615225504, 0.701251086, 0.526844304, 0.170871892, 0.744955134, 
0.971083097, 0.405557882, 0.046901626, 0.29043009, 0.94351491, 0.044139891, 0.00275569, 
0.874575928, 0.310690473, 0.785803991, 0.748262585, 0.273392338, 0.801499673, 0.240218395, 
0.324193252, 0.903508268, 0.500817971, 0.709748855, 0.432034469, 0.86020589, 0.161031738, 
0.906853058, 0.304579044, 0.692154918, 0.794770973, 0.090293456, 0.812545367, 0.828590773, 
0.99261973, 0.123171352, 0.121075189, 0.22075954, 0.900613761, 0.455448103, 0.87222636, 
0.165082287, 0.810701098, 0.466841607, 0.099844515, 0.585930156, 0.945987354, 0.765209354, 
0.202567765, 0.197427529, 0.625514546, 0.024738497, 0.870564964, 0.998001386, 0.012656005, 
0.650950358, 0.624117089, 0.54823967, 0.612410214, 0.064893357, 0.778643638, 0.423121554, 
0.931922465, 0.444825141, 0.13479101, 0.00680549, 0.480039958, 0.214084179, 0.149897702, 
0.095223098, 0.62407509, 0.71597204, 0.783928783, 0.187324025, 0.24162695, 0.687892101, 
0.247224629, 0.487018302, 0.142173433, 0.8487667, 0.66384693, 0.160051254, 0.331084048, 
0.557936345, 0.767207792, 0.097417069, 0.535896684, 0.583967817, 0.487927269, 0.683940142, 
0.940347709, 0.264072996, 0.622855691, 0.465275559, 0.128147529, 0.667976798, 0.26854993, 
0.954604021, 0.608827886, 0.999184584, 0.375959643, 0.316554825, 0.098217846, 0.056692785,
0.012135254, 0.023866478, 0.635045205, 0.54113681, 0.646383392, 0.489061463, 0.422989351, 
0.68985855, 0.17144874, 0.871181522, 0.61401405, 0.749451674, 0.625038802, 0.189926023, 
0.435532412, 0.724509017, 0.640069691, 0.457481766, 0.953868969, 0.799528918, 0.50482334, 
0.293888785, 0.304237624, 0.08337357, 0.019732651, 0.18858572, 0.845430264, 0.885372373, 
0.525296521, 0.536448047, 0.634926836, 0.42985861, 0.11683911, 0.601517153, 0.434292678, 
0.063735091, 0.870653565, 0.511164425, 0.943143079, 0.302004009, 0.469522037, 0.559937758, 
0.331144075, 0.827159609, 0.459371018, 0.50075432, 0.328909559, 0.551762345, 0.247849356, 
0.597740596, 0.219339329, 0.096449215, 0.606475427, 0.210012163, 0.692882567, 0.340988728, 
0.978437728, 0.080579312, 0.673241907, 0.171107243, 0.673373954, 0.578722456, 0.746908575, 
0.819826039, 0.371060262, 0.772933039, 0.049091347, 0.594585186, 0.032731756, 0.887668901,
0.816350353, 0.119653662, 0.888991928, 0.47349272, 0.893378527, 0.24370767, 0.3016206, 
0.247180683, 0.663271786, 0.703809917, 0.289413108, 0.784327238, 0.806478743, 0.126817318, 
0.929026159, 0.185770367, 0.045380051, 0.238038749, 0.080590386, 0.861991595, 0.633239497, 
0.79997923, 0.72037901, 0.385047797, 0.791521466, 0.518788792, 0.023671686, 0.689021323, 
0.591568338, 0.366699294, 0.226162608, 0.93990995, 0.468328175, 0.76384135, 0.626102344, 
0.116933104, 0.551372822, 0.309060555, 0.932307053, 0.528102455, 0.123680236, 0.390860867,
0.024963729, 0.208335888, 0.49546035, 0.154174915, 0.412488367, 0.915448869, 0.048203659, 
0.148217625, 0.748797632, 0.903873665, 0.751313939, 0.703254244, 0.661423664, 0.902184843, 
0.788038558, 0.334650879, 0.118246595, 0.87008554, 0.58391362, 0.19554054, 0.491265978, 
0.024658974, 0.536481714, 0.342415781, 0.512514686, 0.496091288, 0.953910899, 0.211700288, 
0.764753094, 0.312430519, 0.178001811, 0.03626995, 0.556103202, 0.71798615, 0.481323815, 
0.725050541, 0.929083796, 0.332271027, 0.23889589, 0.934789477, 0.11670305, 0.431386264, 
0.426352435, 0.774451709, 0.892701666, 0.689024064, 0.573147839, 0.446274226, 0.119330852, 
0.176348818, 0.945873167, 0.870518801, 0.53101011, 0.617193833, 0.862602546, 0.210802796, 
0.959710188, 0.808411151, 0.381434002, 0.965262154, 0.403555886, 0.613107266, 0.951376656, 
0.621948465, 0.557973518, 0.001005567, 0.566031839, 0.218367284, 0.999588132, 0.369454145, 
0.212056653, 0.766334671, 0.455319999, 0.693843707, 0.636353687, 0.881903595, 0.551213483, 
0.798708922, 0.217218709, 0.692826831, 0.087245533, 0.610292485, 0.359490815, 0.778235516, 
0.897612774, 0.956619041, 0.929268224, 0.824436026, 0.026877246, 0.310268403, 0.570535497, 
0.708699917, 0.988113985, 0.161001983, 0.485250359, 0.873309611, 0.661128834, 0.268644017, 
0.379771054, 0.480941809, 0.237334519, 0.296711986, 0.238331674, 0.108452941, 0.906863359, 
0.995035709, 0.101213407, 0.144294416, 0.905691091, 0.003792027, 0.93663227, 0.682955125, 
0.631066495, 0.504589173, 0.127601663, 0.757465498, 0.064118008, 0.617586259, 0.013573425, 
0.349161836, 0.347057211}; */

/*
//float[] ta = {0.933291597,0.692532198,0.890923328,0.464141647,0.501840953,0.072045355,0.882360699,0.361506687,0.309138957,0.259921089,0.549236684,0.264520748,0.915611787,0.892552443,0.767186759,0.543531209,0.731174302,0.308242074,0.233562829,0.78004555,0.33499096,0.50250442,0.314063316,0.723777408,0.867174473,0.496752931,0.548963214,0.821834026,0.400888144,0.942605632,0.57019116,0.648563104,0.136072212,0.258000571,0.795406036,0.131056985,0.915092781,0.105717142,0.235140524,0.487549498,0.288042488,0.26798111,0.110716191,0.659748367,0.087732852,0.666494834,0.123823093,0.034982492,0.456237522,0.318481541,0.278497066,0.382570267,0.20018626,0.463028602,0.149514472,0.956827579,0.386518737,0.477483089,0.042503113,0.895108433,0.065832459,0.913999454,0.200807196,0.028733142,0.356146434,0.270727626,0.125497583,0.779054746,0.480528178,0.872921817,0.590522359,0.978831194,0.037771558,0.014134947,0.764431937,0.326734641,0.426585753,0.917373353,0.918084581,0.793326518,0.647349224,0.910904137,0.181520055,0.88301644,0.923860019,0.178129814,0.905172982,0.515832035,0.57340882,0.416816399,0.85070004,0.77212229,0.799423257,0.757734612,0.254429809,0.564571791,0.448626005,0.119271535,0.409032155,0.476660079,0.696676547,0.606015861,0.476321752,0.65672166,0.779183951,0.102100994,0.339610796,0.596587781,0.006777298,0.489312577,0.555760731,0.776708121,0.349841201,0.239414867,0.722410031,0.647704715,0.517898022,0.501088754,0.59510381,0.256851875,0.234093612,0.951298074,0.455203117,0.446066873,0.018722344,0.355541726,0.113013209,0.051043233,0.06708343,0.867214304,0.349579327,0.731548262,0.461481691,0.471114938,0.920037714,0.068920604,0.661836531,0.348718787,0.602850251,0.112322454,0.658428697,0.600302323,0.528000776,0.981319869,0.31787815,0.07621781,0.001105035,0.620638805,0.574770866,0.252511998,0.567221219,0.222351245,0.584409842,0.398280675,0.2735745,0.267457078,0.309321469,0.589156912,0.56332317,0.512711387,0.132158626,0.080853418,0.457330652,0.861250662,0.926502667,0.609766718,0.976203766,0.072325847,0.788899808,0.82604215,0.999764881,0.865879334,0.888864487,0.613221936,0.706189972,0.904895915,0.878358587,0.520628142,0.575990033,0.012711131};
//gbs100225
float[] ta = {0.636329293,0.694538851,0.518413088,0.580362477,0.58220023,0.584914414,0.503094021,0.620718785,0.551366455,0.670089226,0.583276835,0.504178245,0.570786649,0.682392794,0.543438321,0.615242693,0.594429847,0.570310865,0.561859115,0.590534602,0.555814891,0.578234895,0.667459196,0.56637526,0.518342475,0.520491232,0.668434611,0.654643161,0.642880543,0.536075111,0.632207422,0.693787393,0.535016321,0.632341592,0.549839941,0.58302134,0.643426576,0.519597216,0.599671899,0.576945809,0.572641404,0.516207729,0.522388429,0.664347356,0.537489272,0.582688888,0.616942635,0.66790258,0.6491855,0.694275772,0.517430751,0.601456226,0.503336574,0.652396634,0.566759983,0.690729086,0.569570361,0.681313788,0.522357725,0.590627797,0.674186298,0.69517709,0.541536134,0.655529906,0.553847998,0.538073338,0.568093653,0.531483248,0.56975454,0.521638152,0.673301152,0.62499929,0.506999904,0.571049778,0.528875865,0.568334432,0.50146096,0.576526168,0.527251077,0.656993316,0.558310128,0.545961859,0.523018519,0.522121985,0.606630095,0.58598001,0.598396652,0.699967339,0.629501076,0.527669777,0.502720963,0.686626843,0.671659426,0.677976484,0.651913323,0.527736607,0.698887492,0.628768055,0.605943141,0.55125177,0.627962234,0.676835616,0.502771106,0.656299181,0.553740979,0.668570124,0.54746822,0.516340271,0.508963421,0.699675215,0.651566779,0.521419164,0.611127359,0.541352677,0.635295247,0.696810301,0.65966912,0.662039477,0.688579098,0.611600324,0.51916275,0.548535407,0.69479389,0.506561367,0.536155134,0.503004049,0.633803459,0.508893985,0.656751312,0.666464843,0.632736994,0.570207162,0.647110832,0.592939416,0.558951629,0.593957489,0.637222567,0.577941064,0.559763543,0.516147086,0.512335408,0.671441337,0.575231219,0.588957453,0.614680058,0.500955209,0.55287986,0.554267538,0.652128714,0.527788731,0.625773649,0.61155553,0.651309372,0.697331164,0.556685746,0.588681181,0.594052797,0.571455036,0.527927972,0.586150719,0.658367565,0.51730676,0.565376222,0.606349707,0.646787465,0.572272559,0.526136873,0.60025016,0.658208198,0.628841226,0.560254879,0.514060482,0.510527799,0.540676004,0.616001229,0.508562865,0.59500652,0.593037738,0.61415856,0.575888107,0.5};
float[] calcPos (float latitude, int doy, int time)
{ // From a model by Jan Goudriaan, obtained 14.2.2008
	float corrTime;
	float ecc = 0.01671; //eccentricity
	float ax = 23.438; //angle of Earth axis
	float daymn1 = 2.0f;
	float daymn2 = 81.0f;
	//float PI = 3.141563;
	float rad = Math.PI/180;
	float corr1 = -4.0*2.0*ecc*Math.sin(2*Math.PI*(doy-daymn1)/365.0f)/rad;
	float corr2 = (ax*rad)*(ax*rad)*Math.sin(4*Math.PI*(doy-daymn2)/365.0f)/rad;
	float corr = corr1 + corr2;
	corrTime = time + corr;
	float sinl = Math.sin(rad * latitude); //ok
	float cosl = Math.cos(rad * latitude); //ok
	//sine of declination, sine delta:
	float sind = -Math.sin(ax*rad)*Math.cos(2*Math.PI*(doy+10)/365); //ok
	//cosine of declination, cosine delta:
	float cosd = Math.sqrt(1-(sind*sind)); //ok
	//cosine of hour angle:
	//float costh = Math.cos(rad*15*(time-12)); //ok
	float costh = Math.cos(2*Math.PI*(time-12)/24);
	//sine of solar height, sine alpha
	float sina = (sinl * sind) + (cosl * cosd * costh);
	//solar height alpha
	//float alpha = Math.asin(sina/rad);
	//cosine of solar height
	float cosa = Math.sqrt(1-(sina*sina));
	//cosine of azimuth, cosine kappa
	float cosk = (sina * sinl - sind)/(cosa * cosl);
	//sine of azimuth, sine kappa
	float sink = Math.sqrt(Math.max(0.000000000001,(1-(cosk*cosk)))) * (((time-12)<0)?-1:1);
	float x = sink * cosa;
	float y = sina;
	float z = cosk * cosa;
	//float S = 1367 * FractionDiffuse(ta[doy-60]) * sina; //gbs100225: factor ta[doy] made up: diffuseness of sky at different days
	float S = 1367 * FractionDiffuse(0.6+random(0,0.3)) * sina; //gbs100225
	float a = sinl * sind;
	float b = cosl * cosd;
	float eccFac = 1 + 0.0033*Math.cos(2*Math.PI*(doy-10)/365); //eccentricity factor, from GvL, p. 30, eq. 3.1b
	float d = 12*(1 + (2/Math.PI)*Math.asin(a/b));//daylength in hours
	//daily total of S0:
	float S0 = a*d+(24*(b/Math.PI))*Math.cos((d/12-1)*(Math.PI/2))*eccFac;
	//return float result[] = {x,y,z,sina,sink};
	return float result[] = {x,y,z,S,S0*3600*1367};
}*/

/*wy131125
protected void initA ()
[
	{
	radiation.clear ().setColumnKey(0,"Fraction diffuse");
	chart (radiation, XY_PLOT);
	}
	Axiom ==> [ Sphere(0.1).(setShader(GREEN)) TextLabel("S") Plane()  ] 
	RL(-90) M(-2) RL(90) A(time,day);
]

private void fd ()
{
	float[] ta = {0, 0.1, 0.2, 0.3, 0.4, 0.5, 0.6, 0.7, 0.8, 0.9, 1.0};
	for (int i=0; i<=10; i++) {radiation.addRow().set(0,FractionDiffuse(ta[i]));}
}*/

/* public void run ()
[
	A(t,d), (t<=24) ==> {
	float[] coords = calcPos(latitude, dayofyear,t);
	float x = coords[0]; float y = coords[1]; float z = coords[2];
	float rad = Math.PI/180;
	float ecc = 0.01671; //eccentricity
	float ax = 23.438; //angle of Earth axis
	float daymn1 = 2.0f;
	float daymn2 = 81.0f;
	float corr1 = -4.0*2.0*ecc*Math.sin(2*Math.PI*(d-daymn1)/365.0f)/rad;
	float corr2 = (ax*rad)*(ax*rad)*Math.sin(4*Math.PI*(d-daymn2)/365.0f)/rad;
	float corr = corr1 + corr2;
	//println(corr);
	radiation.addRow().set(0,FractionDiffuse(ta[d]));
	//println("Day: " + d);
	//println("Hour: " + t);
	}
	[ {float distfact = 2.5;} RU(90) M(x*distfact) RH(90) RU(90) M(z*distfact) 
	RL(-90) M(y*distfact) B((t==24?1:t+1),(t==24?d+1:d),GlobalRadiation[d]) ] 
	A((t==24?1:t+1),(t==24?d+1:d));
	B(t,d,p) ==> ;
] */
